{% extends 'base.html' %}
{% load entry_tags %}

{% block content %}
<h2>
    Entries
    {% if tag %}
    tagged with "{{ tag.name }}"
    {% endif %}
    {% if 'query' in query_params %}
    matching the query "{{ query_params.query }}"
    {% endif %}
</h2>

<form method="get">
    <p>
        {{ form.query }}
        <input type="submit" value="Search"/>
    </p>
</form>

{% if 'query' in query_params %}
{% with num=page_obj.paginator.count %}
<h3>
    {{ num }} result{{ num|pluralize }}
    <a href="{% url 'entry_list' request.user.username %}">
        Clear
    </a>
</h3>
{% endwith %}
{% endif %}

{% for entry in entries %}
{% ifchanged entry.book %}
{% if not forloop.first %}</ul>{% endif %}
<h3>
    <a href="{{ entry.book.get_absolute_url }}">{{ entry.book.title }}</a>
    - {{ entry.book.published }}
</h3>
<p>
    {% for author in entry.book.authors.all %}
    <a href="{{ author.get_absolute_url }}">{{ author }}</a>
    {% if not forloop.last %}, {% endif %}
    {% endfor %}
</p>
<ul>
{% endifchanged %}
    <li>
        <h4>
            {% if entry.status == 'd' %}
            <span>(Draft)</span>
            {% endif %}
            <a href="{{ entry.get_absolute_url }}">{{ entry.publish_dt }}</a>
            - {{ entry.author }}
        </h4>
        <p>
            {% with sec=entry.section chap=entry.chapter %}
            {% if sec %}{{ sec }}{% endif %}{% if sec and chap %}, {% endif %}
            {% if chap %}Chapter {{ chap }}{% endif %}
            {% endwith %}
        </p>
        {% if entry.title %}
        <h4>{{ entry.title }}</h4>
        {% endif %}
        {% if entry.tags.exists %}
        <p>
            Tags:
            {% for tag in entry.tags.all %}
            <a href="{% url 'entry_list' entry.author.username %}?tag={{ tag.slug }}">
                {{ tag }}
            </a>
            {% if not forloop.last %} | {% endif %}
            {% endfor %}
        </p>
        {% endif %}
        <p>{{ entry.body|markdown }}</p>
    </li>
{% if forloop.last %}
</ul>
{% endif %}
{% empty %}
{% if 'query' in query_params %}
<p>No entries match your search</p>
{% else %}
<p>You don't have any entries yet</p>
{% endif %}
{% endfor %}


{% include 'partials/pagination.html' with page=page_obj query_params=query_params %}
{% endblock content %}
